if (!require("BiocManager", quietly = TRUE))
install.packages("BiocManager")
BiocManager::install(c("sva", "edgeR", "limma", "Biobase", "biomaRt",
"clusterProfiler", "EnhancedVolcano", "org.Hs.eg.db",
"org.Mm.eg.db", "org.Rn.eg.db"))
library(data.table)
if (!require("BiocManager", quietly = TRUE))
install.packages("BiocManager")
BiocManager::install(c("sva", "edgeR", "limma", "Biobase", "biomaRt",
"clusterProfiler", "EnhancedVolcano", "org.Hs.eg.db"))
library(data.table)
library(limma)
library(edgeR)
if (!require("BiocManager", quietly = TRUE))
install.packages("BiocManager")
BiocManager::install(c("sva", "edgeR", "limma", "Biobase", "biomaRt",
"clusterProfiler", "EnhancedVolcano", "org.Hs.eg.db"))
library(data.table)
library(limma)
library(edgeR)
library(ggplot2)
library(ggrepel)
library(ggfortify)
library(pheatmap)
library(stats)
library(sva)
setwd("C:/users/mvsan/code/YAP_TAZ_bulkRNAseq/RNAseq/Rep analysis")
#Combine count files into single expression matrix
# Retrieve count file paths
file_names <- list.files(path= ".", pattern = "featureCounts_exon\\.txt$", recursive = F, full.names = T)
# Read all count files into a DGElist
dgls <- readDGE(file_names, columns = c(1, 7), skip = 1)
counts_raw <- as.data.frame(dgls$counts)
# Rename samples
sample_name <- gsub("_featureCounts_exon", "", basename(colnames(counts_raw)))
colnames(counts_raw) <- sample_name
counts_raw <- as.data.frame(dgls$counts)
# Rename samples
sample_name <- gsub("_featureCounts_exon", "", basename(colnames(counts_raw)))
colnames(counts_raw) <- sample_name
# Save the combined count table
fwrite(counts_raw, "counts_raw.tsv", sep = "\t", row.names = T)
#Reading raw count data
count_tbl <- fread("counts_raw.tsv", data.table = F)
#Adding Row Names to the Count Table
rownames(count_tbl) <- count_tbl[[1]]
View(count_tbl)
count_tbl <- count_tbl[, -1]
##FILTERING
#Remove genes with little to no expression
perc_keep <- 0.8
gene_keep <- rowSums(count_tbl > 0) >= ceiling(perc_keep * ncol(count_tbl))
count_tbl_low_rm <- count_tbl[gene_keep, ]
#Creating Meta Data table with info about each sample
meta <- data.frame(SampleID = colnames(count_tbl),
CellType = c("WT", "WT", "WT", "YAPKO", "YAPKO", "YAPKO", "YAP_TAZKO", "YAP_TAZKO", "YAP_TAZKO"))
rownames(meta) <- meta$SampleID
#Combine count data and sample info into object
dge <- DGEList(counts=count_tbl_low_rm, samples = meta)
#Normalize for difficulties between samples
dge <- calcNormFactors(dge, method = "TMM")
dge_v <- voom(dge, plot=TRUE)
View(meta)
# 7. Heatmap of Top Variable Genes
# Calculate variance of each gene
gene_vars <- apply(dge_v$E, 1, var)
gene_var_df <- data.frame(gene_id = names(gene_vars), variance = gene_vars)
gene_var_df <- gene_var_df[order(-gene_var_df$variance),]  # Sort by variance
fwrite(gene_var_df, "gene_variance.tsv", sep="\t", row.names=FALSE)
# Select top 100 most variable genes
top_genes <- names(sort(gene_vars, decreasing = TRUE))[1:100]
log_counts_top <- dge_v$E[top_genes, ]
View(log_counts_top)
# Scale for heatmap (row-wise)
log_counts_top_scaled <- t(scale(t(log_counts_top)))
# Specify the exact sample order you want
sample_order <- c("WT_0", "WT_1", "WT_2", "Y2_0", "Y2_1", "Y2_2", "YT_0", "YT_1", "YT_2")
# Reorder columns and annotation according to your desired sample order
log_counts_top_scaled_ordered <- log_counts_top_scaled[, sample_order]
View(log_counts_top_scaled)
# Specify the exact sample order you want
sample_order <- c("WT_1", "WT_2", "WT_3", "Y2_1", "Y2_2", "Y2_3", "YT_1", "YT_2", "YT_3")
# Reorder columns and annotation according to your desired sample order
log_counts_top_scaled_ordered <- log_counts_top_scaled[, sample_order]
annotation_col_ordered <- data.frame(CellType = meta$CellType)
rownames(annotation_col_ordered) <- meta$SampleID
annotation_col_ordered <- annotation_col_ordered[sample_order, , drop = FALSE]
# Plot heatmap with columns ordered and clustering disabled for columns
mymap <- pheatmap(log_counts_top_scaled_ordered,
cluster_rows = TRUE,
cluster_cols = FALSE,
treeheight_row = 0,  # Set dendrogram height to 0 (hides it)
treeheight_col = 0,  # Set dendrogram height to 0 (hides it)
annotation_col = annotation_col_ordered,
show_rownames = TRUE,
fontsize_row = 5,
fontsize_col = 5,
main = "Top 100 Most Variable Genes")
setwd("C:/users/mvsan/code/YAP_TAZ_bulkRNAseq/RNAseq/Rep analysis")
#Combine count files into single expression matrix
# Retrieve count file paths
file_names <- list.files(path= ".", pattern = "featureCounts_exon\\.txt$", recursive = F, full.names = T)
# Read all count files into a DGElist
dgls <- readDGE(file_names, columns = c(1, 7), skip = 1)
counts_raw <- as.data.frame(dgls$counts)
# Rename samples
sample_name <- gsub("_featureCounts_exon", "", basename(colnames(counts_raw)))
colnames(counts_raw) <- sample_name
# Save the combined count table
fwrite(counts_raw, "counts_raw.tsv", sep = "\t", row.names = T)
#Reading raw count data
count_tbl <- fread("counts_raw.tsv", data.table = F)
#Adding Row Names to the Count Table
rownames(count_tbl) <- count_tbl[[1]]
count_tbl <- count_tbl[, -1]
##FILTERING
#Remove genes with little to no expression
perc_keep <- 0.8
gene_keep <- rowSums(count_tbl > 0) >= ceiling(perc_keep * ncol(count_tbl))
count_tbl_low_rm <- count_tbl[gene_keep, ]
#Creating Meta Data table with info about each sample
meta <- data.frame(SampleID = colnames(count_tbl),
CellType = c("WT", "WT", "WT", "YAPKO", "YAPKO", "YAPKO", "YAP_TAZKO", "YAP_TAZKO", "YAP_TAZKO"))
rownames(meta) <- meta$SampleID
#Combine count data and sample info into object
dge <- DGEList(counts=count_tbl_low_rm, samples = meta)
#Normalize for difficulties between samples
dge <- calcNormFactors(dge, method = "TMM")
dge_v <- voom(dge, plot=TRUE)
##VISULATION
# save the dge_v object for later use
saveRDS(dge_v, "dge_v.rds")
# 7. Heatmap of Top Variable Genes
# Calculate variance of each gene
gene_vars <- apply(dge_v$E, 1, var)
gene_var_df <- data.frame(gene_id = names(gene_vars), variance = gene_vars)
gene_var_df <- gene_var_df[order(-gene_var_df$variance),]  # Sort by variance
fwrite(gene_var_df, "gene_variance.tsv", sep="\t", row.names=FALSE)
# Select top 100 most variable genes
top_genes <- names(sort(gene_vars, decreasing = TRUE))[1:100]
log_counts_top <- dge_v$E[top_genes, ]
# Scale for heatmap (row-wise)
log_counts_top_scaled <- t(scale(t(log_counts_top)))
# Specify the exact sample order you want
sample_order <- c("WT_1", "WT_2", "WT_3", "Y2_1", "Y2_2", "Y2_3", "YT_1", "YT_2", "YT_3")
# Reorder columns and annotation according to your desired sample order
log_counts_top_scaled_ordered <- log_counts_top_scaled[, sample_order]
annotation_col_ordered <- data.frame(CellType = meta$CellType)
rownames(annotation_col_ordered) <- meta$SampleID
annotation_col_ordered <- annotation_col_ordered[sample_order, , drop = FALSE]
# Plot heatmap with columns ordered and clustering disabled for columns
mymap <- pheatmap(log_counts_top_scaled_ordered,
cluster_rows = TRUE,
cluster_cols = FALSE,
treeheight_row = 0,  # Set dendrogram height to 0 (hides it)
treeheight_col = 0,  # Set dendrogram height to 0 (hides it)
annotation_col = annotation_col_ordered,
show_rownames = TRUE,
fontsize_row = 5,
fontsize_col = 5,
main = "Top 100 Most Variable Genes")
# Save to image
ggsave("WT_Y2_YT2_DEG.png", plot=mymap)
